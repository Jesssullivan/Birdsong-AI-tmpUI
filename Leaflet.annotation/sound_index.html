<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="utf-8">
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <title>Leaflet.annotation Example</title>

        <!-- Bootstrap core CSS -->
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/css/bootstrap.min.css" integrity="sha384-Vkoo8x4CGsO3+Hhxv8T/Q5PaXtkKtu6ug5TOeNV6gBiFeWPGFN9MuhOf23Q9Ifjh" crossorigin="anonymous">

        <!-- Leaflet core CSS -->
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css" integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ==" crossorigin=""/>

        <!-- Leaflet Draw CSS -->
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.3/leaflet.draw.css"/>

        <script src="https://kit.fontawesome.com/73cd972fdf.js" crossorigin="anonymous"></script>

    </head>
    <body>
        <div class="container-fluid">

            <div id="annotationHolder"></div>

            <div class="row justify-content-center">
                <div class="col-md-3">
                    <button id="printAnnos" type="button" class="btn btn-primary">Print Annotations</button>
                </div>
            </div>

            <div class="row mt-5">
                <div class="col-md-4">
                    <h6>Audio & Spectrogram Controls</h6>
                    <ul class="list-group-flush">
                        <li class="list-group-item">Space Bar: play and pause</li>
                        <li class="list-group-item">Left Arrow: backwards</li>
                        <li class="list-group-item">Right Arrow: forwards</li>
                    </ul>
                </div>
            </div>

        </div>

        <!-- jQuery first, then Popper.js, then Bootstrap JS -->
        <script src="https://code.jquery.com/jquery-3.4.1.slim.min.js" integrity="sha384-J6qa4849blE2+poT4WnyKhv5vZF5SrPo0iEjwBvKU7imGFAV0wwj1yYfoRSJoZ+n" crossorigin="anonymous"></script>
        <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.0/dist/umd/popper.min.js" integrity="sha384-Q6E9RHvbIyZFJoft+2mJbHaEWldlvI9IOYy5n3zV9zzTtmI3UksdQRVvoxMfooAo" crossorigin="anonymous"></script>
        <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.min.js" integrity="sha384-wfSDF2E50Y2D1uUdj0O3uMBJnjuUD4Ih7YwaYd1iqfktj0Uod8GCExl3Og8ifwB6" crossorigin="anonymous"></script>

        <!-- Load React. -->
        <script src="https://unpkg.com/react@16/umd/react.development.js" crossorigin></script>
        <script src="https://unpkg.com/react-dom@16/umd/react-dom.development.js" crossorigin></script>

        <!-- Our App javascript file -->
        <script src="dist/leaflet.annotation.js"></script>

        <script type="text/javascript">


            $(function() {

                // Example data from the server
                let server_data = {
                    // The image to annotate
                    image : {
                        id : "alder_10.jpg",
                        //audio: "file:///Users/GVH/Desktop/lab_feeder_anno_proc/audio.mp3",
                        //url: "file:///Users/GVH/Desktop/lab_feeder_anno_proc/spectrogram.png",
                        audio : "https://www.dropbox.com/s/0z0r3qz6h93yfpe/audio.mp3?dl=1",
                        url: "https://www.dropbox.com/s/t1r21bhnrxmti8a/spectrogram.png?dl=1",
                        attribution : "Bruce Aird"
                    },
                    // The existing annotations for this image
                    annotations : [
  {
    "id": "63150d9e-5709-47fa-9088-09be5c3c661a",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.03151517250935292,
      0.4816666666666668,
      0.03893399842963374,
      0.4366666666666668
    ],
    "category_id": 1,
    "supercategory": "Bird"
  },
  {
    "id": "103ccafd-c212-4f2a-9694-92613e4e5f08",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.10243914830723756,
      0.46000000000000013,
      0.04368204701861347,
      0.44500000000000006
    ],
    "category_id": 6,
    "supercategory": "Bird"
  },
  {
    "id": "227e8d90-7b52-489d-b25a-e4fbd84927c1",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.0011276615398826846,
      0.5583333333333335,
      0.03667867534986837,
      0.24166666666666664
    ],
    "category_id": 5,
    "supercategory": "Bird"
  },
  {
    "id": "3c623b7b-b697-4846-9824-65b7256b0188",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.07834280171816546,
      0.4933333333333334,
      0.0058757101288624105,
      0.37500000000000006
    ],
    "category_id": 1,
    "supercategory": "Bird"
  },
  {
    "id": "aaa3672a-7553-4e51-8ffb-ec68d01b74e1",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.08837305436238513,
      0.5533333333333335,
      0.0200011546810771,
      0.2783333333333333
    ],
    "category_id": 1,
    "supercategory": "Bird"
  },
  {
    "id": "6c1ef275-9c3d-4065-943d-6cfc969554b5",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.14831716779825416,
      0.43666666666666676,
      0.005816359521500161,
      0.3883333333333334
    ],
    "category_id": 1,
    "supercategory": "Bird"
  },
  {
    "id": "b43e65e5-26bd-4cf0-b744-5aa7198dd060",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.1683776730866935,
      0.42833333333333345,
      0.0061131125583114,
      0.4183333333333334
    ],
    "category_id": 1,
    "supercategory": "Bird"
  },
  {
    "id": "13cf912c-03d6-4e25-a0e3-e57517a05349",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.2181134820562561,
      0.3933333333333334,
      0.007774929564454318,
      0.4983333333333335
    ],
    "category_id": 1,
    "supercategory": "Bird"
  },
  {
    "id": "c749720b-a49c-4154-8eff-8f000f3ffcb4",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.24648307237540998,
      0.3550000000000001,
      0.036381922313057126,
      0.5016666666666667
    ],
    "category_id": 1,
    "supercategory": "Bird"
  },
  {
    "id": "dbb831af-2acc-4060-8322-ff46edd9ecfb",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.28785044570689583,
      0.4616666666666667,
      0.031574523116715165,
      0.4683333333333335
    ],
    "category_id": 1,
    "supercategory": "Bird"
  },
  {
    "id": "1e64ee61-c4f0-405e-becd-e6cb2debdb83",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.3274966514248765,
      0.30916666666666676,
      0.0030862315828368027,
      0.6450000000000002
    ],
    "category_id": 1,
    "supercategory": "Bird"
  },
  {
    "id": "e6fce73d-73c1-4560-994a-e922c9686fd5",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.38803427093436804,
      0.5866666666666669,
      0.024393099625883322,
      0.26333333333333336
    ],
    "category_id": 1,
    "supercategory": "Bird"
  },
  {
    "id": "c9f460b4-8fe2-44bb-b39e-24348fc06cee",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.38031869197727597,
      0.8250000000000002,
      0.02558011177312828,
      0.10000000000000006
    ],
    "category_id": 3,
    "supercategory": "Bird"
  },
  {
    "id": "9d347c7b-b46e-4bb8-8dfc-0e28aef7dc5d",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.1947886933628932,
      0.6166666666666668,
      0.01109856357674012,
      0.2133333333333334
    ],
    "category_id": 4,
    "supercategory": "Bird"
  },
  {
    "id": "aea64cc9-3b0e-4def-852e-532a9c39db88",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.2099230982402661,
      0.5683333333333335,
      0.007656228349729801,
      0.23333333333333345
    ],
    "category_id": 4,
    "supercategory": "Bird"
  },
  {
    "id": "e53a018f-0204-4680-9663-381bd325a0e9",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.47290563946238057,
      0.6416666666666668,
      0.04273243730081752,
      0.17999999999999997
    ],
    "category_id": 5,
    "supercategory": "Bird"
  },
  {
    "id": "21f11443-5978-471b-9aec-e2ff8b289b86",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.48447900789801873,
      0.19500000000000006,
      0.005697658306775608,
      0.7216666666666669
    ],
    "category_id": 1,
    "supercategory": "Bird"
  },
  {
    "id": "87f1d734-d32d-4b61-bb7c-97307abdb6a8",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.47311336658814845,
      0.44333333333333347,
      0.003620387049097076,
      0.44000000000000006
    ],
    "category_id": 1,
    "supercategory": "Bird"
  },
  {
    "id": "5e7052fb-ec65-41ca-9685-ff046149d5ed",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.5170031407325297,
      0.6350000000000002,
      0.011276615398826876,
      0.1916666666666666
    ],
    "category_id": 4,
    "supercategory": "Bird"
  },
  {
    "id": "ef4ce34d-a348-4401-95a0-8cd7b230c446",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.5371823472356936,
      0.46666666666666673,
      0.017271026742413795,
      0.3866666666666667
    ],
    "category_id": 1,
    "supercategory": "Bird"
  },
  {
    "id": "510890dc-241d-4566-97c6-885cf059ea15",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.5539785691192094,
      0.5400000000000001,
      0.011988822687173837,
      0.09833333333333331
    ],
    "category_id": 1,
    "supercategory": "Bird"
  },
  {
    "id": "9ed0c3fc-2488-493a-8ed2-41feac81ecf4",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.5792619278555264,
      0.8250000000000002,
      0.03679737656459288,
      0.08666666666666666
    ],
    "category_id": 3,
    "supercategory": "Bird"
  },
  {
    "id": "b437a867-9fad-4f55-bcaf-6c47f858ce5a",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.6023493141194404,
      0.43666666666666676,
      0.0038577894785460387,
      0.41166666666666674
    ],
    "category_id": 1,
    "supercategory": "Bird"
  },
  {
    "id": "d34d1193-4d85-43d9-9da0-a32fe8b9ca12",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.6205105999722877,
      0.6316666666666668,
      0.06148722922728751,
      0.17500000000000007
    ],
    "category_id": 5,
    "supercategory": "Bird"
  },
  {
    "id": "a608875c-4d8e-4b52-ba7d-6d820530ffd5",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.6841938016719783,
      0.47166666666666673,
      0.040595815435776644,
      0.44333333333333347
    ],
    "category_id": 1,
    "supercategory": "Bird"
  },
  {
    "id": "313d676d-a5cf-4103-99da-292179801ef4",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.7061535263960096,
      0.06500000000000002,
      0.002730127938663287,
      0.8716666666666669
    ],
    "category_id": 1,
    "supercategory": "Bird"
  },
  {
    "id": "717d5444-9e8d-40e9-ad68-ceec1804ed67",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.7481737564084802,
      0.13333333333333336,
      0.004866749803704238,
      0.7883333333333334
    ],
    "category_id": 1,
    "supercategory": "Bird"
  },
  {
    "id": "e2f5d122-3135-42b0-9ea7-5f7f7ec9efde",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.7476396009422198,
      0.5166666666666668,
      0.032524132834511194,
      0.3183333333333334
    ],
    "category_id": 1,
    "supercategory": "Bird"
  },
  {
    "id": "8ac57310-b091-4045-aca1-865f1659aed0",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.789541129739966,
      0.8066666666666669,
      0.03709412960140412,
      0.11999999999999998
    ],
    "category_id": 3,
    "supercategory": "Bird"
  },
  {
    "id": "a92cc917-0a5c-49a5-9c3e-4a542db3d55f",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.8393362893168909,
      0.8116666666666669,
      0.007715578957092077,
      0.1066666666666667
    ],
    "category_id": 3,
    "supercategory": "Bird"
  },
  {
    "id": "d204a076-4302-47b4-a780-e5cef127d802",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.8630765322617894,
      0.8116666666666669,
      0.007596877742367667,
      0.11499999999999996
    ],
    "category_id": 3,
    "supercategory": "Bird"
  },
  {
    "id": "903258e6-1338-4a4f-a534-0ef4e96bc7bf",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.8015299524271399,
      0.6400000000000002,
      0.08237864301879824,
      0.1733333333333333
    ],
    "category_id": 5,
    "supercategory": "Bird"
  },
  {
    "id": "add85ce6-d99e-43f7-b0a8-562959622fa6",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.9484820562560623,
      0.12666666666666668,
      0.004629347374255275,
      0.7800000000000001
    ],
    "category_id": 1,
    "supercategory": "Bird"
  },
  {
    "id": "894a9313-47ee-4c10-9ec8-721a3a2996d3",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.9604115283358738,
      0.3783333333333334,
      0.0035016858343725234,
      0.5416666666666669
    ],
    "category_id": 1,
    "supercategory": "Bird"
  },
  {
    "id": "c28b34a7-6bfe-4083-ac36-973153662602",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.9177384416424185,
      0.6166666666666668,
      0.018695441319107716,
      0.17500000000000007
    ],
    "category_id": 7,
    "supercategory": "Bird"
  },
  {
    "id": "c72d5e53-3936-489e-84f1-4eb60bfe0ec6",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.9798191769433285,
      0.5233333333333334,
      0.01661817006142897,
      0.2733333333333334
    ],
    "category_id": 7,
    "supercategory": "Bird"
  },
  {
    "id": "27f1f4c1-aa20-4dbd-80e4-9fe289dd4621",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.9657530829984761,
      0.6366666666666668,
      0.006647268024571531,
      0.13
    ],
    "category_id": 7,
    "supercategory": "Bird"
  },
  {
    "id": "83e3cfd8-3453-4f4c-8858-7158e051be21",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.40940048958477676,
      0.5466666666666667,
      0.009436746570597237,
      0.2816666666666668
    ],
    "category_id": 4,
    "supercategory": "Bird"
  },
  {
    "id": "632b3b05-ce67-4e90-aa5c-7c14e961b30b",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.4261967114682925,
      0.5716666666666668,
      0.013888042122765683,
      0.2566666666666667
    ],
    "category_id": 4,
    "supercategory": "Bird"
  },
  {
    "id": "28b06f7e-fbba-470f-82af-f71c03719b7a",
    "image_id": "alder_10.jpg",
    "bbox": [
      0.027301279386633417,
      0.5316666666666668,
      0.009733499607408436,
      0.2750000000000001
    ],
    "category_id": 7,
    "supercategory": "Bird"
  }
],
                    // When a creating a new "individual," these are the category labels the user can choose from
                    categories : [{
                        id : 1,
                        name : "Red-winged Blackbird",
                        supercategory : "Bird"
                    },
                    {
                        id : 2,
                        name : "Common Grackle",
                        supercategory : "Bird"
                    },
                    {
                        id : 3,
                        name : "American Crow",
                        supercategory : "Bird"
                    },
                    {
                        id : 4,
                        name : "American Robin",
                        supercategory : "Bird"
                    },
                    {
                        id : 5,
                        name : "Warbling Vireo",
                        supercategory : "Bird"
                    },
                    {
                        id : 6,
                        name : "Balitmore Oriole",
                        supercategory : "Bird"
                    },
                    {
                        id : 7,
                        name : "Gray Catbird",
                        supercategory : "Bird"
                    },
                    {
                        id : 8,
                        name : "Yellow Warbler",
                        supercategory : "Bird"
                    }
                ]
                };

                // Create an image element and load in the pixels
                let imageEl = new Image();
                // We need to have access to the pixels before initializing Leaflet
                imageEl.onload = function(){

                    // Create the Leaflet.annotation element
                    let annotator = React.createElement(document.LeafletAnnotation, {
                        imageElement : imageEl,
                        image : server_data.image,
                        annotations : server_data.annotations,
                        categories : server_data.categories,
                        options : {
                            enableEditingImmediately : true,

                            map : {
                                attributionControl : false,
                                zoomControl : false
                            },

                            newInstance: {
                                annotateCategory: true,
                                annotateSupercategory: false,
                                annotationType: 'box'
                            },

                            showCategory : true,
                            showSupercategory: true,
                            showIsCrowdCheckbox: true,

                            renderBoxes : true
                        }
                    }, null);

                    // Render the annotator
                    let annotatorRendered = ReactDOM.render(annotator, document.getElementById('annotationHolder'));

                    $("#printAnnos").click(function(){
                        let annos = annotatorRendered.getAnnotations();
                        console.log(annos);
                    });

                    // Setup the view for the audio
                    annotatorRendered.fillMap();
                    annotatorRendered.turnOffZoom();
                    //annotatorRendered.turnOffDrag();
                    //annotatorRendered.addVerticalLine(2); // We want a "static" vertical line

                    let spectrogram_height = imageEl.height;
                    let spectrogram_width = imageEl.width;

                    // Audio Controls
                    // space bar is play and pause
                    var pixels_per_second = null;
                    var pixels_per_ms = null;
                    let pan_interval_ms = 10;

                    var audioElement = new Audio(server_data.image.audio);
                    var playing_audio = false;
                    var playing_audio_timing_id = null;
                    var current_offset = 0;

                    // NOTE: there is probably some offset for which we want to account
                    // Perhaps half the window size?
                    //var const_spectrogram_offset = 60;
                    //annotatorRendered.panBy(const_spectrogram_offset);

                    function panSpectrogram() {

                        // Where is the audio in milliseconds
                        let audio_time_ms = audioElement.currentTime * 1000;

                        // Convert milliseconds to pixel translation
                        let offset = pixels_per_ms * audio_time_ms;

                        // What is the difference between the audio pixel offset and the spectrogram?
                        let diff = offset - current_offset;
                        if (diff > 0){
                            annotatorRendered.panBy(diff);
                        }
                        current_offset = offset;

                    }

                    function audioEnded(){
                        clearInterval(playing_audio_timing_id);
                        playing_audio = false;
                    }

                    function startPlaying(){

                        let offset_in_seconds = current_offset / pixels_per_second;
                        audioElement.currentTime = offset_in_seconds;

                        console.log(current_offset);
                        console.log(offset_in_seconds);

                        audioElement.onended = audioEnded;
                        audioElement.play();
                        playing_audio_timing_id = setInterval(panSpectrogram, pan_interval_ms);
                        playing_audio = true;
                    }

                    function stopPlaying(){
                        audioElement.pause();
                        clearInterval(playing_audio_timing_id);
                        playing_audio = false;
                    }

                    function goForward(){

                        if (playing_audio){
                            stopPlaying();
                        }

                        annotatorRendered.panBy(100);
                        current_offset = current_offset + 100;

                    }

                    function goBackward(){

                        if(current_offset == 0){
                            return;
                        }

                        if (playing_audio){
                            stopPlaying();
                        }

                        annotatorRendered.panBy(-100);
                        current_offset = Math.max(0, current_offset - 100);

                    }

                    function handleKeyDown(e){

                        let SPACE_KEY = 32; // Pause Play
                        let RIGHT_ARROW_KEY = 39; // Forward
                        let LEFT_ARROW_KEY = 37; // Backward

                        switch(e.keyCode){
                            case SPACE_KEY:
                                if(playing_audio){
                                    stopPlaying();
                                }
                                else{
                                    startPlaying();
                                }
                                break;
                            case RIGHT_ARROW_KEY:
                                goForward()
                                break;
                            case LEFT_ARROW_KEY:
                                goBackward()
                                break;
                        }

                        e.preventDefault(); // prevent the space button from scrolling

                    }

                    function enableAudioKeys(){
                        // Register keypresses
                        document.addEventListener("keydown", handleKeyDown);
                    }

                    function disableAudioKeys(){
                        // Unregister keypresses
                        document.removeEventListener("keydown", handleKeyDown);
                    }


                    // Load in the audio for the spectrogram
                    audioElement.addEventListener('loadeddata', () => {
                        let duration = audioElement.duration;
                        // The duration variable now holds the duration (in seconds) of the audio clip

                        pixels_per_second = spectrogram_width / duration;

                        pixels_per_ms = pixels_per_second / 1000.0;

                        console.log("Spectrogram Height: " +  spectrogram_height);
                        console.log("Spectrogram Width: " +  spectrogram_width);
                        console.log("Duration " + duration);
                        console.log("Pixels / second : " + pixels_per_second);
                        console.log("Pixels / milisecond : " + pixels_per_ms);
                        console.log("Current Time " + audioElement.currentTime);

                        enableAudioKeys();

                    })

                }
                imageEl.src = server_data.image.url;
            });
        </script>

    </body>
</html>